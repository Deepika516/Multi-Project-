import { Injectable } from '@angular/core';
import { forkJoin, from, of } from 'rxjs';
import { first, mergeMap, tap } from 'rxjs/operators';
import { DEFAULT_REDIRECT_KEY } from '../model/permissions-router-data.model';
import { isFunction, isPlainObject, transformStringToArray } from '../utils/utils';
import * as i0 from "@angular/core";
import * as i1 from "../service/permissions.service";
import * as i2 from "../service/roles.service";
import * as i3 from "@angular/router";
export class NgxPermissionsGuard {
    constructor(permissionsService, rolesService, router) {
        this.permissionsService = permissionsService;
        this.rolesService = rolesService;
        this.router = router;
    }
    canActivate(route, state) {
        return this.hasPermissions(route, state);
    }
    canActivateChild(childRoute, state) {
        return this.hasPermissions(childRoute, state);
    }
    canLoad(route) {
        return this.hasPermissions(route);
    }
    canMatch(route) {
        return this.hasPermissions(route);
    }
    hasPermissions(route, state) {
        const routeDataPermissions = !!route && route.data ? route.data['permissions'] : {};
        const permissions = this.transformPermission(routeDataPermissions, route, state);
        if (this.isParameterAvailable(permissions.except)) {
            return this.passingExceptPermissionsValidation(permissions, route, state);
        }
        if (this.isParameterAvailable(permissions.only)) {
            return this.passingOnlyPermissionsValidation(permissions, route, state);
        }
        return true;
    }
    transformPermission(permissions, route, state) {
        const only = isFunction(permissions.only)
            ? permissions.only(route, state)
            : transformStringToArray(permissions.only);
        const except = isFunction(permissions.except)
            ? permissions.except(route, state)
            : transformStringToArray(permissions.except);
        const redirectTo = permissions.redirectTo;
        return {
            only,
            except,
            redirectTo
        };
    }
    isParameterAvailable(permission) {
        return !!permission && permission.length > 0;
    }
    passingExceptPermissionsValidation(permissions, route, state) {
        if (!!permissions.redirectTo
            && ((isFunction(permissions.redirectTo))
                || (isPlainObject(permissions.redirectTo) && !this.isRedirectionWithParameters(permissions.redirectTo)))) {
            let failedPermission = '';
            return from(permissions.except)
                .pipe(mergeMap(permissionsExcept => {
                return forkJoin([
                    this.permissionsService.hasPermission(permissionsExcept),
                    this.rolesService.hasOnlyRoles(permissionsExcept)
                ]).pipe(tap(hasPermissions => {
                    const dontHavePermissions = hasPermissions.every(hasPermission => hasPermission === false);
                    if (!dontHavePermissions) {
                        failedPermission = permissionsExcept;
                    }
                }));
            }), first(hasPermissions => hasPermissions.some(hasPermission => hasPermission === true), false), mergeMap(isAllFalse => {
                if (!!failedPermission) {
                    this.handleRedirectOfFailedPermission(permissions, failedPermission, route, state);
                    return of(false);
                }
                if (!isAllFalse && permissions.only) {
                    return this.onlyRedirectCheck(permissions, route, state);
                }
                return of(!isAllFalse);
            }))
                .toPromise();
        }
        return Promise.all([
            this.permissionsService.hasPermission(permissions.except),
            this.rolesService.hasOnlyRoles(permissions.except)
        ]).then(([hasPermission, hasRoles]) => {
            if (hasPermission || hasRoles) {
                if (permissions.redirectTo) {
                    this.redirectToAnotherRoute(permissions.redirectTo, route, state);
                }
                return false;
            }
            if (permissions.only) {
                return this.checkOnlyPermissions(permissions, route, state);
            }
            return true;
        });
    }
    redirectToAnotherRoute(permissionRedirectTo, route, state, failedPermissionName) {
        const redirectTo = isFunction(permissionRedirectTo)
            ? permissionRedirectTo(failedPermissionName, route, state)
            : permissionRedirectTo;
        if (this.isRedirectionWithParameters(redirectTo)) {
            redirectTo.navigationCommands = this.transformNavigationCommands(redirectTo.navigationCommands, route, state);
            redirectTo.navigationExtras = this.transformNavigationExtras(redirectTo.navigationExtras, route, state);
            this.router.navigate(redirectTo.navigationCommands, redirectTo.navigationExtras);
            return;
        }
        if (Array.isArray(redirectTo)) {
            this.router.navigate(redirectTo);
        }
        else {
            this.router.navigate([redirectTo]);
        }
    }
    isRedirectionWithParameters(object) {
        return (isPlainObject(object) && (!!object.navigationCommands || !!object.navigationExtras));
    }
    transformNavigationCommands(navigationCommands, route, state) {
        return isFunction(navigationCommands)
            ? navigationCommands(route, state)
            : navigationCommands;
    }
    transformNavigationExtras(navigationExtras, route, state) {
        return isFunction(navigationExtras)
            ? navigationExtras(route, state)
            : navigationExtras;
    }
    onlyRedirectCheck(permissions, route, state) {
        let failedPermission = '';
        return from(permissions.only)
            .pipe(mergeMap(permissionsOnly => {
            return forkJoin([
                this.permissionsService.hasPermission(permissionsOnly),
                this.rolesService.hasOnlyRoles(permissionsOnly)
            ]).pipe(tap(hasPermissions => {
                const failed = hasPermissions.every(hasPermission => hasPermission === false);
                if (failed) {
                    failedPermission = permissionsOnly;
                }
            }));
        }), first(hasPermissions => {
            if (isFunction(permissions.redirectTo)) {
                return hasPermissions.some(hasPermission => hasPermission === true);
            }
            return hasPermissions.every(hasPermission => hasPermission === false);
        }, false), mergeMap((pass) => {
            if (isFunction(permissions.redirectTo)) {
                if (pass) {
                    return of(true);
                }
                else {
                    this.handleRedirectOfFailedPermission(permissions, failedPermission, route, state);
                    return of(false);
                }
            }
            else {
                if (!!failedPermission) {
                    this.handleRedirectOfFailedPermission(permissions, failedPermission, route, state);
                }
                return of(!pass);
            }
        }))
            .toPromise();
    }
    handleRedirectOfFailedPermission(permissions, failedPermission, route, state) {
        if (this.isFailedPermissionPropertyOfRedirectTo(permissions, failedPermission)) {
            this.redirectToAnotherRoute(permissions.redirectTo[failedPermission], route, state, failedPermission);
        }
        else {
            if (isFunction(permissions.redirectTo)) {
                this.redirectToAnotherRoute(permissions.redirectTo, route, state, failedPermission);
            }
            else {
                this.redirectToAnotherRoute(permissions.redirectTo[DEFAULT_REDIRECT_KEY], route, state, failedPermission);
            }
        }
    }
    isFailedPermissionPropertyOfRedirectTo(permissions, failedPermission) {
        return (!!permissions.redirectTo && permissions.redirectTo[failedPermission]);
    }
    checkOnlyPermissions(purePermissions, route, state) {
        const permissions = {
            ...purePermissions
        };
        return Promise.all([
            this.permissionsService.hasPermission(permissions.only),
            this.rolesService.hasOnlyRoles(permissions.only)
        ]).then(([hasPermission, hasRole]) => {
            if (hasPermission || hasRole) {
                return true;
            }
            if (permissions.redirectTo) {
                this.redirectToAnotherRoute(permissions.redirectTo, route, state);
            }
            return false;
        });
    }
    passingOnlyPermissionsValidation(permissions, route, state) {
        if ((isFunction(permissions.redirectTo)
            || isPlainObject(permissions.redirectTo) && !this.isRedirectionWithParameters(permissions.redirectTo))) {
            return this.onlyRedirectCheck(permissions, route, state);
        }
        return this.checkOnlyPermissions(permissions, route, state);
    }
}
NgxPermissionsGuard.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.2", ngImport: i0, type: NgxPermissionsGuard, deps: [{ token: i1.NgxPermissionsService }, { token: i2.NgxRolesService }, { token: i3.Router }], target: i0.ɵɵFactoryTarget.Injectable });
NgxPermissionsGuard.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.2.2", ngImport: i0, type: NgxPermissionsGuard });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.2", ngImport: i0, type: NgxPermissionsGuard, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.NgxPermissionsService }, { type: i2.NgxRolesService }, { type: i3.Router }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVybWlzc2lvbnMtZ3VhcmQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1wZXJtaXNzaW9ucy9zcmMvbGliL3JvdXRlci9wZXJtaXNzaW9ucy1ndWFyZC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFZM0MsT0FBTyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RELE9BQU8sRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXRELE9BQU8sRUFDSCxvQkFBb0IsRUFTdkIsTUFBTSx3Q0FBd0MsQ0FBQztBQUdoRCxPQUFPLEVBQUUsVUFBVSxFQUFFLGFBQWEsRUFBRSxzQkFBc0IsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7OztBQVNuRixNQUFNLE9BQU8sbUJBQW1CO0lBRTVCLFlBQW9CLGtCQUF5QyxFQUFVLFlBQTZCLEVBQVUsTUFBYztRQUF4Ryx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQXVCO1FBQVUsaUJBQVksR0FBWixZQUFZLENBQWlCO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBUTtJQUM1SCxDQUFDO0lBRUQsV0FBVyxDQUFDLEtBQTZCLEVBQUUsS0FBMEI7UUFDakUsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBRUQsZ0JBQWdCLENBQUMsVUFBa0MsRUFBRSxLQUEwQjtRQUMzRSxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsVUFBVSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ2xELENBQUM7SUFFRCxPQUFPLENBQUMsS0FBWTtRQUNoQixPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDdEMsQ0FB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LElBQUksQ0FBQztTQUNuRCxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxhQUFhLEVBQUUsT0FBTyxDQUFDLEVBQUUsRUFBRTtZQUNqQyxJQUFJLGFBQWEsSUFBSSxPQUFPLEVBQUU7Z0JBQzFCLE9BQU8sSUFBSSxDQUFDO2FBQ2Y7WUFFRCxJQUFJLFdBQVcsQ0FBQyxVQUFVLEVBQUU7Z0JBQ3hCLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxXQUFXLENBQUMsVUFBVSxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQzthQUNyRTtZQUVELE9BQU8sS0FBSyxDQUFDO1FBQ2pCLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVTLGdDQUFnQyxDQUN0QyxXQUErQixFQUMvQixLQUFxQyxFQUNyQyxLQUEyQjtRQUUzQixJQUNJLENBQUMsVUFBVSxDQUFlLFdBQVcsQ0FBQyxVQUFVLENBQUM7ZUFDMUMsYUFBYSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLENBQUMsRUFDNUc7WUFDRSxPQUFPLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQzVEO1FBQ0QsT0FBTyxJQUFJLENBQUMsb0JBQW9CLENBQUMsV0FBVyxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNoRSxDQUFDOztnSEFuU1EsbUJBQW1CO29IQUFuQixtQkFBbUI7MkZBQW5CLG1CQUFtQjtrQkFEL0IsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gICAgQWN0aXZhdGVkUm91dGVTbmFwc2hvdCxcbiAgICBDYW5BY3RpdmF0ZSxcbiAgICBDYW5BY3RpdmF0ZUNoaWxkLFxuICAgIENhbkxvYWQsIENhbk1hdGNoLFxuICAgIE5hdmlnYXRpb25FeHRyYXMsXG4gICAgUm91dGUsXG4gICAgUm91dGVyLFxuICAgIFJvdXRlclN0YXRlU25hcHNob3Rcbn0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcblxuaW1wb3J0IHsgZm9ya0pvaW4sIGZyb20sIE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaXJzdCwgbWVyZ2VNYXAsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHtcbiAgICBERUZBVUxUX1JFRElSRUNUX0tFWSxcbiAgICBFeGNlcHRGbixcbiAgICBOYXZpZ2F0aW9uQ29tbWFuZHNGbixcbiAgICBOYXZpZ2F0aW9uRXh0cmFzRm4sXG4gICAgTmd4UGVybWlzc2lvbnNSb3V0ZXJEYXRhLFxuICAgIE5neFJlZGlyZWN0VG9OYXZpZ2F0aW9uUGFyYW1ldGVycyxcbiAgICBPbmx5Rm4sXG4gICAgUmVkaXJlY3RUbyxcbiAgICBSZWRpcmVjdFRvRm5cbn0gZnJvbSAnLi4vbW9kZWwvcGVybWlzc2lvbnMtcm91dGVyLWRhdGEubW9kZWwnO1xuaW1wb3J0IHsgTmd4UGVybWlzc2lvbnNTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZS9wZXJtaXNzaW9ucy5zZXJ2aWNlJztcbmltcG9ydCB7IE5neFJvbGVzU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2Uvcm9sZXMuc2VydmljZSc7XG5pbXBvcnQgeyBpc0Z1bmN0aW9uLCBpc1BsYWluT2JqZWN0LCB0cmFuc2Zvcm1TdHJpbmdUb0FycmF5IH0gZnJvbSAnLi4vdXRpbHMvdXRpbHMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIE5neFBlcm1pc3Npb25zRGF0YSB7XG4gICAgb25seT86IHN0cmluZyB8IHN0cmluZ1tdO1xuICAgIGV4Y2VwdD86IHN0cmluZyB8IHN0cmluZ1tdO1xuICAgIHJlZGlyZWN0VG8/OiBSZWRpcmVjdFRvIHwgUmVkaXJlY3RUb0ZuO1xufVxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTmd4UGVybWlzc2lvbnNHdWFyZCBpbXBsZW1lbnRzIENhbkFjdGl2YXRlLCBDYW5Mb2FkLCBDYW5BY3RpdmF0ZUNoaWxkLCBDYW5NYXRjaCB7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHBlcm1pc3Npb25zU2VydmljZTogTmd4UGVybWlzc2lvbnNTZXJ2aWNlLCBwcml2YXRlIHJvbGVzU2VydmljZTogTmd4Um9sZXNTZXJ2aWNlLCBwcml2YXRlIHJvdXRlcjogUm91dGVyKSB7XG4gICAgfVxuXG4gICAgY2FuQWN0aXZhdGUocm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QsIHN0YXRlOiBSb3V0ZXJTdGF0ZVNuYXBzaG90KTogUHJvbWlzZTxib29sZWFuPiB8IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNQZXJtaXNzaW9ucyhyb3V0ZSwgc3RhdGUpO1xuICAgIH1cblxuICAgIGNhbkFjdGl2YXRlQ2hpbGQoY2hpbGRSb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCwgc3RhdGU6IFJvdXRlclN0YXRlU25hcHNob3QpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHwgUHJvbWlzZTxib29sZWFuPiB8IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNQZXJtaXNzaW9ucyhjaGlsZFJvdXRlLCBzdGF0ZSk7XG4gICAgfVxuXG4gICAgY2FuTG9hZChyb3V0ZTogUm91dGUpOiBib29sZWFuIHwgT2JzZXJ2YWJsZTxib29sZWFuPiB8IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNQZXJtaXNzaW9ucyhyb3V0ZSk7XG4gICAgfVxuXG4gICAgY2FuTWF0Y2gocm91dGU6IFJvdXRlKTogYm9vbGVhbiB8IE9ic2VydmFibGU8Ym9vbGVhbj4gfCBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaGFzUGVybWlzc2lvbnMocm91dGUpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBoYXNQZXJtaXNzaW9ucyhyb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCB8IFJvdXRlLCBzdGF0ZT86IFJvdXRlclN0YXRlU25hcHNob3QpIHtcbiAgICAgICAgY29uc3Qgcm91dGVEYXRhUGVybWlzc2lvbnMgPSAhIXJvdXRlICYmIHJvdXRlLmRhdGEgPyAocm91dGUuZGF0YVsncGVybWlzc2lvbnMnXSBhcyBOZ3hQZXJtaXNzaW9uc1JvdXRlckRhdGEpIDoge307XG4gICAgICAgIGNvbnN0IHBlcm1pc3Npb25zID0gdGhpcy50cmFuc2Zvcm1QZXJtaXNzaW9uKHJvdXRlRGF0YVBlcm1pc3Npb25zLCByb3V0ZSwgc3RhdGUpO1xuXG4gICAgICAgIGlmICh0aGlzLmlzUGFyYW1ldGVyQXZhaWxhYmxlKHBlcm1pc3Npb25zLmV4Y2VwdCkpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhc3NpbmdFeGNlcHRQZXJtaXNzaW9uc1ZhbGlkYXRpb24ocGVybWlzc2lvbnMsIHJvdXRlLCBzdGF0ZSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5pc1BhcmFtZXRlckF2YWlsYWJsZShwZXJtaXNzaW9ucy5vbmx5KSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMucGFzc2luZ09ubHlQZXJtaXNzaW9uc1ZhbGlkYXRpb24ocGVybWlzc2lvbnMsIHJvdXRlLCBzdGF0ZSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgdHJhbnNmb3JtUGVybWlzc2lvbihcbiAgICAgICAgcGVybWlzc2lvbnM6IE5neFBlcm1pc3Npb25zUm91dGVyRGF0YSxcbiAgICAgICAgcm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QgfCBSb3V0ZSxcbiAgICAgICAgc3RhdGU/OiBSb3V0ZXJTdGF0ZVNuYXBzaG90XG4gICAgKTogTmd4UGVybWlzc2lvbnNEYXRhIHtcbiAgICAgICAgY29uc3Qgb25seSA9IGlzRnVuY3Rpb248T25seUZuPihwZXJtaXNzaW9ucy5vbmx5KVxuICAgICAgICAgICAgPyBwZXJtaXNzaW9ucy5vbmx5KHJvdXRlLCBzdGF0ZSlcbiAgICAgICAgICAgIDogdHJhbnNmb3JtU3RyaW5nVG9BcnJheShwZXJtaXNzaW9ucy5vbmx5KTtcbiAgICAgICAgY29uc3QgZXhjZXB0ID0gaXNGdW5jdGlvbjxFeGNlcHRGbj4ocGVybWlzc2lvbnMuZXhjZXB0KVxuICAgICAgICAgICAgPyBwZXJtaXNzaW9ucy5leGNlcHQocm91dGUsIHN0YXRlKVxuICAgICAgICAgICAgOiB0cmFuc2Zvcm1TdHJpbmdUb0FycmF5KHBlcm1pc3Npb25zLmV4Y2VwdCk7XG4gICAgICAgIGNvbnN0IHJlZGlyZWN0VG8gPSBwZXJtaXNzaW9ucy5yZWRpcmVjdFRvO1xuXG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIG9ubHksXG4gICAgICAgICAgICBleGNlcHQsXG4gICAgICAgICAgICByZWRpcmVjdFRvXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGlzUGFyYW1ldGVyQXZhaWxhYmxlKHBlcm1pc3Npb246IHN0cmluZyB8IHN0cmluZ1tdKSB7XG4gICAgICAgIHJldHVybiAhIXBlcm1pc3Npb24gJiYgcGVybWlzc2lvbi5sZW5ndGggPiAwO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBwYXNzaW5nRXhjZXB0UGVybWlzc2lvbnNWYWxpZGF0aW9uKFxuICAgICAgICBwZXJtaXNzaW9uczogTmd4UGVybWlzc2lvbnNEYXRhLFxuICAgICAgICByb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCB8IFJvdXRlLFxuICAgICAgICBzdGF0ZTogUm91dGVyU3RhdGVTbmFwc2hvdFxuICAgICk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgICAhIXBlcm1pc3Npb25zLnJlZGlyZWN0VG9cbiAgICAgICAgICAgICYmIChcbiAgICAgICAgICAgICAgICAoaXNGdW5jdGlvbjxSZWRpcmVjdFRvRm4+KHBlcm1pc3Npb25zLnJlZGlyZWN0VG8pKVxuICAgICAgICAgICAgICAgIHx8IChpc1BsYWluT2JqZWN0KHBlcm1pc3Npb25zLnJlZGlyZWN0VG8pICYmICF0aGlzLmlzUmVkaXJlY3Rpb25XaXRoUGFyYW1ldGVycyhwZXJtaXNzaW9ucy5yZWRpcmVjdFRvKSlcbiAgICAgICAgICAgIClcbiAgICAgICAgKSB7XG4gICAgICAgICAgICBsZXQgZmFpbGVkUGVybWlzc2lvbiA9ICcnO1xuXG4gICAgICAgICAgICByZXR1cm4gZnJvbShwZXJtaXNzaW9ucy5leGNlcHQpXG4gICAgICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgIG1lcmdlTWFwKHBlcm1pc3Npb25zRXhjZXB0ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmb3JrSm9pbihbXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wZXJtaXNzaW9uc1NlcnZpY2UuaGFzUGVybWlzc2lvbihwZXJtaXNzaW9uc0V4Y2VwdCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yb2xlc1NlcnZpY2UuaGFzT25seVJvbGVzKHBlcm1pc3Npb25zRXhjZXB0KVxuICAgICAgICAgICAgICAgICAgICAgICAgXSkucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXAoaGFzUGVybWlzc2lvbnMgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkb250SGF2ZVBlcm1pc3Npb25zID0gaGFzUGVybWlzc2lvbnMuZXZlcnkoaGFzUGVybWlzc2lvbiA9PiBoYXNQZXJtaXNzaW9uID09PSBmYWxzZSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFkb250SGF2ZVBlcm1pc3Npb25zKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWRQZXJtaXNzaW9uID0gcGVybWlzc2lvbnNFeGNlcHQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgICAgIGZpcnN0KGhhc1Blcm1pc3Npb25zID0+IGhhc1Blcm1pc3Npb25zLnNvbWUoaGFzUGVybWlzc2lvbiA9PiBoYXNQZXJtaXNzaW9uID09PSB0cnVlKSwgZmFsc2UpLFxuICAgICAgICAgICAgICAgICAgICBtZXJnZU1hcChpc0FsbEZhbHNlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghIWZhaWxlZFBlcm1pc3Npb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZVJlZGlyZWN0T2ZGYWlsZWRQZXJtaXNzaW9uKHBlcm1pc3Npb25zLCBmYWlsZWRQZXJtaXNzaW9uLCByb3V0ZSwgc3RhdGUpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0FsbEZhbHNlICYmIHBlcm1pc3Npb25zLm9ubHkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5vbmx5UmVkaXJlY3RDaGVjayhwZXJtaXNzaW9ucywgcm91dGUsIHN0YXRlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKCFpc0FsbEZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgLnRvUHJvbWlzZSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgIHRoaXMucGVybWlzc2lvbnNTZXJ2aWNlLmhhc1Blcm1pc3Npb24ocGVybWlzc2lvbnMuZXhjZXB0KSxcbiAgICAgICAgICAgIHRoaXMucm9sZXNTZXJ2aWNlLmhhc09ubHlSb2xlcyhwZXJtaXNzaW9ucy5leGNlcHQpXG4gICAgICAgIF0pLnRoZW4oKFtoYXNQZXJtaXNzaW9uLCBoYXNSb2xlc10pID0+IHtcbiAgICAgICAgICAgIGlmIChoYXNQZXJtaXNzaW9uIHx8IGhhc1JvbGVzKSB7XG4gICAgICAgICAgICAgICAgaWYgKHBlcm1pc3Npb25zLnJlZGlyZWN0VG8pIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWRpcmVjdFRvQW5vdGhlclJvdXRlKFxuICAgICAgICAgICAgICAgICAgICAgICAgcGVybWlzc2lvbnMucmVkaXJlY3RUbyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJvdXRlLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGVcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChwZXJtaXNzaW9ucy5vbmx5KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2hlY2tPbmx5UGVybWlzc2lvbnMocGVybWlzc2lvbnMsIHJvdXRlLCBzdGF0ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHJlZGlyZWN0VG9Bbm90aGVyUm91dGUoXG4gICAgICAgIHBlcm1pc3Npb25SZWRpcmVjdFRvOiBSZWRpcmVjdFRvIHwgUmVkaXJlY3RUb0ZuLFxuICAgICAgICByb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCB8IFJvdXRlLFxuICAgICAgICBzdGF0ZT86IFJvdXRlclN0YXRlU25hcHNob3QsXG4gICAgICAgIGZhaWxlZFBlcm1pc3Npb25OYW1lPzogc3RyaW5nXG4gICAgKTogdm9pZCB7XG5cbiAgICAgICAgY29uc3QgcmVkaXJlY3RUbyA9IGlzRnVuY3Rpb248UmVkaXJlY3RUb0ZuPihwZXJtaXNzaW9uUmVkaXJlY3RUbylcbiAgICAgICAgICAgID8gcGVybWlzc2lvblJlZGlyZWN0VG8oZmFpbGVkUGVybWlzc2lvbk5hbWUsIHJvdXRlLCBzdGF0ZSlcbiAgICAgICAgICAgIDogcGVybWlzc2lvblJlZGlyZWN0VG87XG5cbiAgICAgICAgaWYgKHRoaXMuaXNSZWRpcmVjdGlvbldpdGhQYXJhbWV0ZXJzKHJlZGlyZWN0VG8pKSB7XG4gICAgICAgICAgICByZWRpcmVjdFRvLm5hdmlnYXRpb25Db21tYW5kcyA9IHRoaXMudHJhbnNmb3JtTmF2aWdhdGlvbkNvbW1hbmRzKHJlZGlyZWN0VG8ubmF2aWdhdGlvbkNvbW1hbmRzLCByb3V0ZSwgc3RhdGUpO1xuICAgICAgICAgICAgcmVkaXJlY3RUby5uYXZpZ2F0aW9uRXh0cmFzID0gdGhpcy50cmFuc2Zvcm1OYXZpZ2F0aW9uRXh0cmFzKHJlZGlyZWN0VG8ubmF2aWdhdGlvbkV4dHJhcywgcm91dGUsIHN0YXRlKTtcbiAgICAgICAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKHJlZGlyZWN0VG8ubmF2aWdhdGlvbkNvbW1hbmRzLCByZWRpcmVjdFRvLm5hdmlnYXRpb25FeHRyYXMpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkocmVkaXJlY3RUbykpIHtcbiAgICAgICAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKHJlZGlyZWN0VG8pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoW3JlZGlyZWN0VG9dKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBpc1JlZGlyZWN0aW9uV2l0aFBhcmFtZXRlcnMob2JqZWN0OiBhbnkgfCBOZ3hSZWRpcmVjdFRvTmF2aWdhdGlvblBhcmFtZXRlcnMpOiBvYmplY3QgaXMgTmd4UmVkaXJlY3RUb05hdmlnYXRpb25QYXJhbWV0ZXJzIHtcbiAgICAgICAgcmV0dXJuIChpc1BsYWluT2JqZWN0KG9iamVjdCkgJiYgKCEhb2JqZWN0Lm5hdmlnYXRpb25Db21tYW5kcyB8fCAhIW9iamVjdC5uYXZpZ2F0aW9uRXh0cmFzKSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHRyYW5zZm9ybU5hdmlnYXRpb25Db21tYW5kcyhcbiAgICAgICAgbmF2aWdhdGlvbkNvbW1hbmRzOiBhbnlbXSB8IE5hdmlnYXRpb25Db21tYW5kc0ZuLFxuICAgICAgICByb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCB8IFJvdXRlLFxuICAgICAgICBzdGF0ZT86IFJvdXRlclN0YXRlU25hcHNob3RcbiAgICApOiBhbnlbXSB7XG4gICAgICAgIHJldHVybiBpc0Z1bmN0aW9uPE5hdmlnYXRpb25Db21tYW5kc0ZuPihuYXZpZ2F0aW9uQ29tbWFuZHMpXG4gICAgICAgICAgICA/IG5hdmlnYXRpb25Db21tYW5kcyhyb3V0ZSwgc3RhdGUpXG4gICAgICAgICAgICA6IG5hdmlnYXRpb25Db21tYW5kcztcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgdHJhbnNmb3JtTmF2aWdhdGlvbkV4dHJhcyhcbiAgICAgICAgbmF2aWdhdGlvbkV4dHJhczogTmF2aWdhdGlvbkV4dHJhcyB8IE5hdmlnYXRpb25FeHRyYXNGbixcbiAgICAgICAgcm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QgfCBSb3V0ZSxcbiAgICAgICAgc3RhdGU/OiBSb3V0ZXJTdGF0ZVNuYXBzaG90XG4gICAgKTogTmF2aWdhdGlvbkV4dHJhcyB7XG4gICAgICAgIHJldHVybiBpc0Z1bmN0aW9uPE5hdmlnYXRpb25FeHRyYXNGbj4obmF2aWdhdGlvbkV4dHJhcylcbiAgICAgICAgICAgID8gbmF2aWdhdGlvbkV4dHJhcyhyb3V0ZSwgc3RhdGUpXG4gICAgICAgICAgICA6IG5hdmlnYXRpb25FeHRyYXM7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIG9ubHlSZWRpcmVjdENoZWNrKFxuICAgICAgICBwZXJtaXNzaW9uczogTmd4UGVybWlzc2lvbnNEYXRhLFxuICAgICAgICByb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCB8IFJvdXRlLFxuICAgICAgICBzdGF0ZT86IFJvdXRlclN0YXRlU25hcHNob3RcbiAgICApOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgbGV0IGZhaWxlZFBlcm1pc3Npb24gPSAnJztcblxuICAgICAgICByZXR1cm4gZnJvbShwZXJtaXNzaW9ucy5vbmx5KVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWVyZ2VNYXAocGVybWlzc2lvbnNPbmx5ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZvcmtKb2luKFtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGVybWlzc2lvbnNTZXJ2aWNlLmhhc1Blcm1pc3Npb24ocGVybWlzc2lvbnNPbmx5KSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucm9sZXNTZXJ2aWNlLmhhc09ubHlSb2xlcyhwZXJtaXNzaW9uc09ubHkpXG4gICAgICAgICAgICAgICAgICAgIF0pLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgICAgICB0YXAoaGFzUGVybWlzc2lvbnMgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZhaWxlZCA9IGhhc1Blcm1pc3Npb25zLmV2ZXJ5KGhhc1Blcm1pc3Npb24gPT4gaGFzUGVybWlzc2lvbiA9PT0gZmFsc2UpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZhaWxlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWRQZXJtaXNzaW9uID0gcGVybWlzc2lvbnNPbmx5O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgZmlyc3QoaGFzUGVybWlzc2lvbnMgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb248UmVkaXJlY3RUb0ZuPihwZXJtaXNzaW9ucy5yZWRpcmVjdFRvKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBoYXNQZXJtaXNzaW9ucy5zb21lKGhhc1Blcm1pc3Npb24gPT4gaGFzUGVybWlzc2lvbiA9PT0gdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBoYXNQZXJtaXNzaW9ucy5ldmVyeShoYXNQZXJtaXNzaW9uID0+IGhhc1Blcm1pc3Npb24gPT09IGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgZmFsc2UpLFxuICAgICAgICAgICAgICAgIG1lcmdlTWFwKFxuICAgICAgICAgICAgICAgICAgICAocGFzczogYm9vbGVhbik6IE9ic2VydmFibGU8Ym9vbGVhbj4gPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb248UmVkaXJlY3RUb0ZuPihwZXJtaXNzaW9ucy5yZWRpcmVjdFRvKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXNzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvZih0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZVJlZGlyZWN0T2ZGYWlsZWRQZXJtaXNzaW9uKHBlcm1pc3Npb25zLCBmYWlsZWRQZXJtaXNzaW9uLCByb3V0ZSwgc3RhdGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YoZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEhZmFpbGVkUGVybWlzc2lvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZVJlZGlyZWN0T2ZGYWlsZWRQZXJtaXNzaW9uKHBlcm1pc3Npb25zLCBmYWlsZWRQZXJtaXNzaW9uLCByb3V0ZSwgc3RhdGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YoIXBhc3MpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLnRvUHJvbWlzZSgpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBoYW5kbGVSZWRpcmVjdE9mRmFpbGVkUGVybWlzc2lvbihcbiAgICAgICAgcGVybWlzc2lvbnM6IE5neFBlcm1pc3Npb25zRGF0YSxcbiAgICAgICAgZmFpbGVkUGVybWlzc2lvbjogc3RyaW5nLFxuICAgICAgICByb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCB8IFJvdXRlLFxuICAgICAgICBzdGF0ZT86IFJvdXRlclN0YXRlU25hcHNob3RcbiAgICApIHtcbiAgICAgICAgaWYgKHRoaXMuaXNGYWlsZWRQZXJtaXNzaW9uUHJvcGVydHlPZlJlZGlyZWN0VG8ocGVybWlzc2lvbnMsIGZhaWxlZFBlcm1pc3Npb24pKSB7XG4gICAgICAgICAgICB0aGlzLnJlZGlyZWN0VG9Bbm90aGVyUm91dGUocGVybWlzc2lvbnMucmVkaXJlY3RUb1tmYWlsZWRQZXJtaXNzaW9uXSwgcm91dGUsIHN0YXRlLCBmYWlsZWRQZXJtaXNzaW9uKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uPFJlZGlyZWN0VG9Gbj4ocGVybWlzc2lvbnMucmVkaXJlY3RUbykpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlZGlyZWN0VG9Bbm90aGVyUm91dGUocGVybWlzc2lvbnMucmVkaXJlY3RUbywgcm91dGUsIHN0YXRlLCBmYWlsZWRQZXJtaXNzaW9uKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZWRpcmVjdFRvQW5vdGhlclJvdXRlKHBlcm1pc3Npb25zLnJlZGlyZWN0VG9bREVGQVVMVF9SRURJUkVDVF9LRVldLCByb3V0ZSwgc3RhdGUsIGZhaWxlZFBlcm1pc3Npb24pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGlzRmFpbGVkUGVybWlzc2lvblByb3BlcnR5T2ZSZWRpcmVjdFRvKHBlcm1pc3Npb25zOiBOZ3hQZXJtaXNzaW9uc0RhdGEsIGZhaWxlZFBlcm1pc3Npb246IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gKCEhcGVybWlzc2lvbnMucmVkaXJlY3RUbyAmJiBwZXJtaXNzaW9ucy5yZWRpcmVjdFRvW2ZhaWxlZFBlcm1pc3Npb25dKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgY2hlY2tPbmx5UGVybWlzc2lvbnMoXG4gICAgICAgIHB1cmVQZXJtaXNzaW9uczogTmd4UGVybWlzc2lvbnNEYXRhLFxuICAgICAgICByb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCB8IFJvdXRlLFxuICAgICAgICBzdGF0ZT86IFJvdXRlclN0YXRlU25hcHNob3RcbiAgICApOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgY29uc3QgcGVybWlzc2lvbnM6IE5neFBlcm1pc3Npb25zRGF0YSA9IHtcbiAgICAgICAgICAgIC4uLnB1cmVQZXJtaXNzaW9uc1xuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbChbXG4gICAgICAgICAgICB0aGlzLnBlcm1pc3Npb25zU2VydmljZS5oYXNQZXJtaXNzaW9uKHBlcm1pc3Npb25zLm9ubHkpLFxuICAgICAgICAgICAgdGhpcy5yb2xlc1NlcnZpY2UuaGFzT25seVJvbGVzKHBlcm1pc3Npb25zLm9ubHkpXG4gICAgICAgIF0pLnRoZW4oKFtoYXNQZXJtaXNzaW9uLCBoYXNSb2xlXSkgPT4ge1xuICAgICAgICAgICAgaWYgKGhhc1Blcm1pc3Npb24gfHwgaGFzUm9sZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocGVybWlzc2lvbnMucmVkaXJlY3RUbykge1xuICAgICAgICAgICAgICAgIHRoaXMucmVkaXJlY3RUb0Fub3RoZXJSb3V0ZShwZXJtaXNzaW9ucy5yZWRpcmVjdFRvLCByb3V0ZSwgc3RhdGUpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBwYXNzaW5nT25seVBlcm1pc3Npb25zVmFsaWRhdGlvbihcbiAgICAgICAgcGVybWlzc2lvbnM6IE5neFBlcm1pc3Npb25zRGF0YSxcbiAgICAgICAgcm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QgfCBSb3V0ZSxcbiAgICAgICAgc3RhdGU/OiBSb3V0ZXJTdGF0ZVNuYXBzaG90XG4gICAgKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICAgIChpc0Z1bmN0aW9uPFJlZGlyZWN0VG9Gbj4ocGVybWlzc2lvbnMucmVkaXJlY3RUbylcbiAgICAgICAgICAgICAgICB8fCBpc1BsYWluT2JqZWN0KHBlcm1pc3Npb25zLnJlZGlyZWN0VG8pICYmICF0aGlzLmlzUmVkaXJlY3Rpb25XaXRoUGFyYW1ldGVycyhwZXJtaXNzaW9ucy5yZWRpcmVjdFRvKSlcbiAgICAgICAgKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5vbmx5UmVkaXJlY3RDaGVjayhwZXJtaXNzaW9ucywgcm91dGUsIHN0YXRlKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5jaGVja09ubHlQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucywgcm91dGUsIHN0YXRlKTtcbiAgICB9XG59XG4iXX0=